{% extends "base.html" %}

{% block title %}系统日志 - Sentinel哨兵{% endblock %}

{% block content %}
<div class="page-header">
    <h1>系统运行日志</h1>
    <p>实时查看系统运行状态与错误信息</p>
</div>

<section class="log-page-card">
    <div class="log-toolbar">
        <div class="log-tabs" role="tablist" aria-label="日志筛选">
            <button
                type="button"
                class="log-tab button button-secondary {% if tab == 'all' %}active{% endif %}"
                data-tab="all"
                role="tab"
                aria-selected="{{ 'true' if tab == 'all' else 'false' }}"
            >
                全部日志
            </button>
            <button
                type="button"
                class="log-tab button button-secondary {% if tab == 'error' %}active{% endif %}"
                data-tab="error"
                role="tab"
                aria-selected="{{ 'true' if tab == 'error' else 'false' }}"
            >
                Error日志
            </button>
        </div>
        <div id="log-connection-state" class="log-connection-state">连接中...</div>
    </div>

    <pre id="log-output" class="log-output" aria-live="polite"></pre>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
    var output = document.getElementById("log-output");
    var statusEl = document.getElementById("log-connection-state");
    var tabButtons = document.querySelectorAll(".log-tab");
    var currentTab = "{{ tab }}";
    var source = null;
    var logLines = [];
    var MAX_LINES = 500;

    function keepLatestVisible() {
        output.scrollTop = 0;
    }

    function renderLines() {
        output.textContent = logLines.join("\n");
        requestAnimationFrame(keepLatestVisible);
    }

    function setStatus(text, statusClass) {
        statusEl.textContent = text;
        statusEl.classList.remove("is-ok", "is-warn");
        if (statusClass) {
            statusEl.classList.add(statusClass);
        }
    }

    function appendLine(line) {
        logLines.unshift(line || "");
        if (logLines.length > MAX_LINES) {
            logLines.length = MAX_LINES;
        }
        renderLines();
    }

    function setActiveTab(nextTab) {
        currentTab = nextTab === "error" ? "error" : "all";
        tabButtons.forEach(function (btn) {
            var active = btn.dataset.tab === currentTab;
            btn.classList.toggle("active", active);
            btn.setAttribute("aria-selected", active ? "true" : "false");
        });
        var nextUrl = "/logs?tab=" + encodeURIComponent(currentTab);
        window.history.replaceState({}, "", nextUrl);
    }

    function connectStream() {
        if (source) {
            source.close();
        }
        logLines = [];
        output.textContent = "";
        setStatus("连接中...", "is-warn");

        source = new EventSource("/api/logs/stream?tab=" + encodeURIComponent(currentTab) + "&lines=120");

        source.onopen = function () {
            setStatus("实时连接已建立", "is-ok");
        };

        source.onmessage = function (event) {
            appendLine(event.data || "");
        };

        source.onerror = function () {
            setStatus("连接断开，正在自动重连...", "is-warn");
        };
        requestAnimationFrame(keepLatestVisible);
    }

    tabButtons.forEach(function (button) {
        button.addEventListener("click", function () {
            var nextTab = button.dataset.tab || "all";
            if (nextTab === currentTab) {
                return;
            }
            setActiveTab(nextTab);
            connectStream();
        });
    });

    setActiveTab(currentTab);
    connectStream();

    window.addEventListener("beforeunload", function () {
        if (source) {
            source.close();
        }
    });
});
</script>
{% endblock %}
